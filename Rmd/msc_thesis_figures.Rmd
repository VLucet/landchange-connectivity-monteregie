---
title: "Msc Thesis Figures"
author: "Valentin Lucet"
date: "17/07/2020"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = normalizePath(".."))
suppressPackageStartupMessages({
  library(raster)
  library(sf)
  library(tidyverse)
  library(ggplot2)
  library(gganimate)
  library(transformr)
  library(animation)
  library(rasterVis)
  library(ggmap)
  library(gifski)
  library(gtools)
  library(fmsb)
  library(RColorBrewer)
  library(scales)
  library(ggradar)
  library(tidymodels)
  library(patchwork)
})
theme_set(theme_minimal())
theme_update(legend.position = c(0.85, 0.20),
             legend.box = "vertical",
             legend.background = element_blank(),
             legend.box.background = element_rect(colour = "black"),
             panel.border = element_rect(fill = NA),
             legend.title = element_text(size = 15),
             legend.text = element_text(size = 13),
             plot.title = element_text(size=20),
             plot.subtitle = element_text(size=20),
             axis.text.x = element_text(angle=65, vjust=0.6, size =13),
             axis.text.y = element_text(size =13),
             strip.text.x = element_text(size = 13),
             strip.text.y = element_text(13),
             axis.title=element_text(size=18))
```

### Data prep

#### Cleaning and formatting

We start by preparing the data from the outputs of scripts `7.1` and `8.1`. The results table shown as output is the key to read the figures. 

```{r data_prep, message=FALSE, warning=FALSE, paged.print=TRUE}
# Results dir + mun shapefile
mun <- st_read("data/mun/munic_SHP_clean.shp", quiet = TRUE)

# Classes
classes <- read_csv("config/rcl_tables/land_use/recode_table.csv")
forest_classes <- read_csv("config/rcl_tables/land_use/recode_table_forest.csv") %>% 
  rename(new_code = "ID", new_class = "Name")

classes_unique <- unique(classes[, c("new_code", "new_class")]) %>% 
  bind_rows(forest_classes)

# results key
sce_code_vec <- 
  as.vector(t(outer(c("BAU-", "R-", "CorPr-", "R-CorPr-", "R(T)-CorPr-"), 
                    c("Hist", "Base", "RCP8"), paste0)))
sce_code_vec_run <- 
  rep(c("BAU", "R", "CorPr", "R-CorPr", "R(T)-CorPr"), each=3)

results_clean <- read_rds("data/temp/stsim_run_results.RDS") %>% 
  dplyr::select(scenarioId, name) %>% 
  mutate(name =  gsub(.$name, pattern = " \\(.+\\)", replacement = "")) %>% 
  mutate(sce =  paste0("sce_", .$scenarioId)) %>% 
  mutate(chapter = c("none", rep("both", 3), rep("chap_1", 3), rep("chap_2", 9))) %>% 
  mutate(splitted = str_split(name, " \\| ")) %>% 
  mutate(climate = unlist(map(splitted, ~unlist(.x[2])))) %>% 
  mutate(run = unlist(map(splitted, ~unlist(.x[1])))) %>% 
  dplyr::select(-splitted) %>% 
  replace_na(list(climate = "none")) %>% 
  mutate(code = c("Control", sce_code_vec)) %>% 
  mutate(code_run = c("control", sce_code_vec_run))

# Final extracted datasets
df_final <- readRDS("outputs/final/final_df_current_density.RDS") %>%
  mutate(timestep = (timestep*10)+1990, source = "model")
df_final_origin <- readRDS("outputs/final/final_df_origin_current_density.RDS") %>%
  mutate(timestep = timestep*10+1990, source = "model")

# Stratum key
stratum_key <- read_csv("config/stsim/SecondaryStratum.csv") %>%
  mutate(ID = as.factor(ID)) %>%
  rename(zone=ID, MUS_NM_MUN=Name) %>%
  left_join(df_final, by="zone") %>%
  filter(MUS_NM_MUN!="Not Monteregie")

# Sum all municipalities
df_summarised <- df_final %>%
  group_by(sce, timestep, species, iteration) %>% 
  summarise(sum_cur = sum(current)) %>% ungroup %>%
  mutate(source = "model")
df_origin_summarised <- df_final_origin %>%
  group_by(timestep, species) %>% 
  summarise(sum_cur = sum(mean)) %>% ungroup %>% 
  mutate(sce = "sce_0", source = "observation")

# Joined dataset
joined <- full_join(df_summarised, df_origin_summarised, 
                    by=c("sce", "source", "species", "timestep", "sum_cur")) %>% 
  left_join(results_clean, by = "sce")  %>% 
  replace_na(list(climate = "none", run = "historic run")) %>% 
  # Make factors
  mutate(sce = as.factor(sce), run = as.factor(run), sum_cur = 10*(sum_cur),
         climate = factor(climate, levels = c("none", "historic",
                                              "baseline", "RCP 8.5")),
         run = factor(run, levels = c("historic run", "BAU run", 
                                      "BAU run + corrs protection", "BAU run + ref", 
                                      "BAU run + corrs protection + ref",
                                      "BAU run + corrs protection + ref TARGETED")))

# Roc curves data
urb <- readRDS("data/temp/fit_rs_outcome_rf_urb_2.RDS")
agex <- readRDS("data/temp/fit_rs_outcome_rf_agex_2.RDS")

# Histogram data 
hist_original <- read_csv("outputs/final/final_values_output_original.csv")
hist_true <- read_csv("outputs/final/final_values_output_TRUE.csv") %>% 
  mutate(sce = "TRUE")
histograms <- read_csv("outputs/final/final_values_output.csv") %>% 
  bind_rows(hist_original) %>% 
  bind_rows(hist_true) %>% 
  left_join(results_clean, by="sce") 


# SURF Data
surf <- read_csv("surf/surf_output.csv") %>% 
  mutate(timestep = timestep*10+1990) %>% 
  left_join(results_clean, by=c("scenario"="scenarioId")) %>% 
  replace_na(list(climate = "none", run = "historic run")) %>% 
  # Make factors
  mutate(sce = as.factor(sce), run = as.factor(run),
         climate = factor(climate, levels = c("none", "historic",
                                              "baseline", "RCP 8.5")),
         run = factor(run, levels = c("historic run", "BAU run", 
                                      "BAU run + corrs protection", "BAU run + ref", 
                                      "BAU run + corrs protection + ref",
                                      "BAU run + corrs protection + ref TARGETED")))

results_clean
```

Preparing for spatial plotting (time consuming).

```{r data_prep_spatial, eval=FALSE, message=FALSE, warning=FALSE}
# Pivoted dataset for mapping
# df_final_fordiff_pivoted <- df_final %>% 
#   left_join(results_clean, by = "sce")  %>% 
#   group_by(zone, sce, species, timestep, source, chapter) %>% 
#   summarise(current = mean(current)) %>% ungroup %>% 
#   filter(timestep %in% c(2010, last(unique(stratum_key$timestep)))) %>% 
#   pivot_wider(names_from=timestep, values_from=current) %>% drop_na() %>% 
#   rename(before=last_col(offset = 1), after=last_col()) %>% 
#   left_join(stratum_key, by=c("zone", "sce", "species", "source")) %>% 
#   filter(MUS_NM_MUN!="Not Monteregie") %>% 
#   mutate(change=((after-before)/before)*100) %>% 
#   left_join(mun, by="MUS_NM_MUN") %>% 
#   st_as_sf()
# 
# df_final_fordiff_pivoted <- 
#   st_transform(df_final_fordiff_pivoted, crs=4326)
```

### Figures

### Mean current flow change

#### Historic

```{r fig_1_historic, message=FALSE, out.width="100%", fig.cap="Connectivity change for species through time, 1990-2010"}
fig_1_historic <- joined %>% 
  filter(climate == "none") %>% 
  group_by(scenarioId, species, iteration) %>% 
  group_modify(~mutate(.x , baseline = subset(.x, timestep == 1990)$sum_cur, 
                       the_diff = ((sum_cur-baseline)/baseline)*100 )) %>% 
  ggplot(aes(x=timestep, y=the_diff, col=source)) +
  scale_color_manual(values=c('#d8b365','#5ab4ac'), 
                     labels = c("Model", "Observation")) +
  geom_smooth(aes(group = sce), method = "glm", se=FALSE) +
  scale_linetype_manual(values = c(1,3,2,5))+
  geom_point(aes(group = sce)) +
  facet_wrap(~species, scales = "fixed") +
  labs(y = "Current flow (% Change)",
       x = "Year",
       col = "Source") +
  NULL
fig_1_historic
ggsave(fig_1_historic,
       filename = "../msc-thesis-mcgill/figures/connectivity_decrease_x5species_historic.png",
       width = 15, height = 15, dpi = 500)
```
#### Chap 1

##### Line graph

```{r figure_1_model_1, out.width="100%", fig.cap="Connectivity change for species through time, 2010-2100", message=FALSE}
fig_1_static_chap_1 <- joined %>% 
  filter(climate != "none", chapter %in% c("none", "both", "chap_1")) %>% 
  group_by(scenarioId, species, iteration) %>% 
  group_modify(~mutate(.x , baseline = subset(.x, timestep == 2010)$sum_cur, 
                       the_diff = ((sum_cur-baseline)/baseline)*100 )) %>% 
  ggplot(aes(x=timestep, y=the_diff, col=climate)) +
  scale_color_manual(values=c('#ffe300', '#ff7a14', "#b31400"), 
                     labels = c("Historic", "Baseline", "RCP 8.5")) +
  geom_smooth(aes(group = sce, linetype=code_run), alpha=0.5, method="loess") +
  #geom_point(aes(group = sce)) +
  scale_linetype_manual(values=c("solid", "twodash")) +
  facet_wrap(~species, scales = "fixed") +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  #geom_vline(xintercept = 2020, linetype = "dashed", color = "darkGreen", alpha = 0.5) +
  labs(y = "Current flow (% Change)",
       x = "Year",
       col = "Climate",
       linetype = "Run") +
  guides(col = guide_legend(ncol = 2, nrow=2), 
         linetype = guide_legend(nrow=1, override.aes = list(colour = 'black'))) +
  theme(legend.position = c(0.85, 0.15))+
  NULL
fig_1_static_chap_1
ggsave(fig_1_static_chap_1, 
       filename = "../msc-thesis-mcgill/figures/connectivity_decrease_x5species_chap1.png", 
       width = 15, height = 15)
```

##### Radar Graph

```{r figure_1_model_1_radar, out.width="100%"}
radar_data_chap1 <- joined %>% 
  filter(climate != "none", chapter %in% c("none", "both", "chap_1")) %>% 
  group_by(timestep, species, code) %>% 
  summarise(sum_cur = mean(sum_cur)) %>% ungroup %>% 
  pivot_wider(names_from = timestep, values_from = sum_cur) %>% 
  mutate(diff = ((`2100`-`2010`)/`2010`)*100) %>% 
  select(-c(`2010`:`2100`)) %>%  
  pivot_wider(names_from = code, values_from = diff) %>% 
  rename(group = species)

radar_chap1 <-  
  ggradar(radar_data_chap1, centre.y = -20, legend.position = "right",
          grid.min = -20, grid.max = 3, grid.mid = 0, 
          values.radar = c("-20 %", "0 %", ""), 
          gridline.label.offset	=5, legend.text.size= 12,
          group.line.width =0.8,
          background.circle.colour	= "#ffffff", group.point.size	= 2, 
          axis.label.size=5)
radar_chap1
ggsave("../msc-thesis-mcgill/figures/radar_ggradar_chap1.png", radar_chap1, width = 15, height = 10)
```

#### Chap 2

```{r figure_1_model_2, out.width="100%", fig.cap="Connectivity change for species through time, 2010-2100", message=FALSE}
fig_1_static_chap_2 <- joined %>% 
  filter(climate != "none", chapter %in% c("none", "both", "chap_2")) %>% 
  group_by(scenarioId, species, iteration) %>% 
  group_modify(~mutate(.x , baseline = subset(.x, timestep == 2010)$sum_cur, 
                       the_diff = ((sum_cur-baseline)/baseline)*100 )) %>% 
  ggplot(aes(x=timestep, y=the_diff, col=climate)) +
  scale_color_manual(values=c('#ffe300', '#ff7a14', "#b31400"), 
                     labels = c("Historic", "Baseline", "RCP 8.5")) +
  geom_smooth(aes(group = sce, linetype=code_run), alpha=0.5, method="loess") +
  scale_linetype_manual(values=c("solid", "dashed", "longdash", "dotted")) +
  facet_wrap(~species, scales = "fixed") +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "darkGreen", alpha = 0.5) +
  labs(y = "Current flow (% Change)",
       x = "Year",
       col = "Climate",
       linetype = "Run") +
  guides(col = guide_legend(ncol = 2, nrow=2), 
         linetype = guide_legend(nrow = 2, ncol=2, 
                                 override.aes = list(colour = 'black'))) +
  theme(legend.position = c(0.85, 0.15))+
  NULL
fig_1_static_chap_2
ggsave(fig_1_static_chap_2, 
       filename = "../msc-thesis-mcgill/figures/connectivity_decrease_x5species_chap2.png", 
       width = 15, height = 15)
```
##### Radar Graph

```{r figure_1_model_2_radar, out.width="100%"}
radar_data_chap2 <- joined %>% 
  filter(climate != "none", chapter %in% c("none", "both","chap_2")) %>% 
  group_by(timestep, species, code) %>% 
  summarise(sum_cur = mean(sum_cur)) %>% ungroup %>% 
  pivot_wider(names_from = timestep, values_from = sum_cur) %>% 
  mutate(diff = ((`2100`-`2010`)/`2010`)*100) %>% 
  select(-c(`2010`:`2100`)) %>%  
  pivot_wider(names_from = code, values_from = diff) %>% 
  rename(group = species)

radar_chap2 <-  
  ggradar(radar_data_chap2, centre.y = -20, legend.position = "right",
          grid.min = -20, grid.max = 3, grid.mid = 0, 
          values.radar = c("-20 %", "0 %", ""), 
          gridline.label.offset	=5, legend.text.size= 12,
          group.line.width =0.8,
          background.circle.colour	= "#ffffff", group.point.size	= 2, 
          axis.label.size=5)
radar_chap2
ggsave("../msc-thesis-mcgill/figures/radar_ggradar_chap2.png", radar_chap2, width = 15, height = 10)
```

#### Both 

##### Radar Graph

```{r figure_1_model_both_radar, out.width="100%"}
radar_data_all <- joined %>% 
  filter(climate != "none") %>% 
  group_by(timestep, species, code) %>% 
  summarise(sum_cur = mean(sum_cur)) %>% ungroup %>% 
  pivot_wider(names_from = timestep, values_from = sum_cur) %>% 
  mutate(diff = ((`2100`-`2010`)/`2010`)*100) %>% 
  select(-c(`2010`:`2100`)) %>%  
  pivot_wider(names_from = code, values_from = diff) %>% 
  rename(group = species)

radar_all <-  
  ggradar(radar_data_all, centre.y = -20, legend.position = "right",
          grid.min = -20, grid.max = 3, grid.mid = 0, 
          values.radar = c("-20 %", "0 %", ""), 
          gridline.label.offset	=5, legend.text.size= 12,
          group.line.width =0.8,
          background.circle.colour	= "#ffffff", group.point.size	= 2, 
          axis.label.size=5)
radar_all
ggsave("../msc-thesis-mcgill/figures/radar_ggradar_both.png", radar_all, width = 15, height = 10)
```

### Map of change

Mapping takes a lot of time, not knitted by default

#### Chap 

```{r figure_2_chap1, eval=FALSE, message=FALSE, warning=FALSE}
# change_1 <- df_final_fordiff_pivoted %>% 
#   filter(chapter %in% c("none", "both", "chap_1")) %>%
#   filter(sce %in% c('sce_39', 'sce_39')) %>% 
#   ggplot(aes(fill=change)) +
#   geom_sf(show.legend=T, lwd = 0)  + 
#   facet_wrap(~sce) + 
#   ggtitle("Connectivity change in %", 
#           subtitle = "2010-2100") +
#   scale_fill_binned(low='#d13e11', high='#fff7bc', 
#                     breaks=c(-50, -40, -30, -20, -10, 0, 10))
# change_1
#ggsave("../msc-thesis-mcgill/figures/connectivit_change_mun_chap1.png", change_1)
```

#### Chap 2

```{r figure_2_chap2, eval=FALSE, message=FALSE, warning=FALSE}
# change_2 <- df_final_fordiff_pivoted %>% 
#   filter(chapter %in% c("none", "both", "chap_2")) %>%
#   ggplot(aes(fill=change)) +
#   geom_sf(show.legend=T, lwd = 0)  + 
#   facet_wrap(~sce) + 
#   ggtitle("Connectivity change in %", 
#           subtitle = "2010-2100") +
#   scale_fill_binned(low='#d13e11', high='#fff7bc', 
#                     breaks=c(-50, -40, -30, -20, -10, 0, 10))
# change_2
#ggsave("../msc-thesis-mcgill/figures/connectivit_change_mun_chap2.png", change_2)
```

#### Both

```{r figure_2_all, eval=FALSE, message=FALSE, warning=FALSE}
# change_both <- df_final_fordiff_pivoted %>% 
#   ggplot(aes(fill=change)) +
#   geom_sf(show.legend=T, lwd = 0)  + 
#   facet_wrap(~sce) + 
#   ggtitle("Connectivity change in %", 
#           subtitle = "2010-2100") +
#   scale_fill_binned(low='#d13e11', high='#fff7bc', 
#                     breaks=c(-50, -40, -30, -20, -10, 0, 10))
# change_both
#ggsave("../msc-thesis-mcgill/figures/connectivit_change_mun_both.png", change_both)
```

### ROC Curves

ROC curves from fitting both models, plotting with `patchwork` package.

```{r roc_curves, message=FALSE, warning=FALSE, out.width="100%"}
p1 <- bind_rows(urb, .id = "fold") %>% 
  mutate(Fold = factor(fold, levels = as.character(1:10))) %>% 
  group_by(Fold) %>% 
  roc_curve(.pred, truth = outcome_fact) %>% 
  autoplot(add=T) +
  ggtitle(paste("Urbanisation")) +
  annotate(x = 0.75, y = 0.25, geom="label", size = 3,
           label = as.character(paste("Av AUC = 0.938 +/- 0.002"))) +
  theme(legend.position = "none") +
  NULL

p2 <- bind_rows(agex, .id = "fold") %>% 
  mutate(Fold = factor(fold, levels = as.character(1:10))) %>% 
  group_by(Fold) %>% 
  roc_curve(.pred, truth = outcome_fact) %>% 
  autoplot(add=T) +
  ggtitle(paste("Agricultural Expansion")) +
  annotate(x = 0.75, y = 0.25, geom="label", size = 3,
           label = as.character(paste("Av AUC = 0.929 +/- 0.002"))) +
  NULL

full = p1 + p2

full
ggsave("../msc-thesis-mcgill/figures/double_roc_resample.png", full)
```

### Histograms

#### Chap 1

```{r hist_plot_1, out.width="100%"}
hist_plot_1 <- histograms %>% 
  mutate(ts = as.factor(ts)) %>% 
  filter(chapter %in% c('both', 'chap_1')) %>%  
  ggplot(aes(x=bins, y=n, group=ts, colour=ts)) + 
  geom_density(stat='identity', show.legend=F, aes(fill=factor(ts)), alpha=0.3)+
  facet_grid(code~species) +
  labs(x = "Flow intensity distribution (log)", 
       y = "")+
  theme(strip.text.y = element_text(angle=360, size=10, hjust = 0), 
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.text.y.left = element_blank(),
        axis.ticks.y.left = element_blank()) +
  NULL
hist_plot_1
ggsave("../msc-thesis-mcgill/figures/hist_chap1.png", hist_plot_1, width = 15, height = 15)
```

#### Chap 2

```{r hist_plot_2, out.width="100%"}
hist_plot_2 <- histograms %>% 
  mutate(ts = as.factor(ts)) %>% 
  filter(chapter %in% c('both', 'chap_2')) %>%  
  ggplot(aes(x=bins, y=n, group=ts, colour=ts)) + 
  geom_density(stat='identity', show.legend=F, aes(fill=factor(ts)), alpha=0.3)+
  facet_grid(code~species) +
  labs(x = "Flow intensity distribution (log)", 
       y = "") +
  theme(strip.text.y = element_text(angle=360, size=10, hjust = 0), 
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.text.y.left = element_blank(),
        axis.ticks.y.left = element_blank()) +
  NULL
hist_plot_2
ggsave("../msc-thesis-mcgill/figures/hist_chap2.png", hist_plot_2, width = 15, height = 20)
```

### SURF Analysis

#### Chap1

##### Linear Graph

```{r surf_1, message=FALSE}
surf_1 <- surf %>% 
  mutate(scenario = as.factor(scenario)) %>% 
  filter(climate != "none", chapter %in% c("none", "both", "chap_1")) %>% 
  filter(climate != "none") %>% 
  group_by(scenario, species, iter) %>% 
  group_modify(~mutate(.x , baseline = subset(.x, timestep == 2010)$kp_nb, 
                       the_diff = ((kp_nb-baseline)/baseline)*100 )) %>% ungroup %>% 
  ggplot(aes(x = timestep, y = the_diff, color=climate)) +
  geom_smooth(aes(group = scenario, linetype=code_run), alpha=0.2, method="loess")+
  #geom_point(aes(group=scenario), alpha= 0.05, size = 0.5)+
  facet_wrap(~species, scales = "fixed")+
  scale_color_manual(values=c('#ffe300', '#ff7a14', "#b31400"), 
                     labels = c("Historic", "Baseline", "RCP 8.5")) +
  labs(y = "Change in nb of Keypoints detected (%)",
       x = "Year",
       col = "Climate",
       linetype = "Run") +
  guides(col = guide_legend(ncol = 2, nrow=2), 
         linetype = guide_legend(nrow=1, override.aes = list(colour = 'black'))) +
  NULL
surf_1
ggsave("../msc-thesis-mcgill/figures/surf_chap1.png", surf_1, width = 15, height = 15)
```

##### Radar Graph

```{r surf_radar_1, message=FALSE}
surf_radar_data_1 <- surf %>% 
  filter(climate != "none", chapter %in% c("none", "both","chap_1")) %>% 
  filter(sce != "sce_0", name != "historic run") %>% 
  group_by(timestep, species, code) %>% 
  summarise(kp_nb = mean(kp_nb)) %>% ungroup %>% 
  pivot_wider(names_from = timestep, values_from = kp_nb) %>% 
  mutate(diff = ((`2100`-`2010`)/`2010`)*100) %>% 
  select(-c(`2010`:`2100`)) %>%  
  pivot_wider(names_from = code, values_from = diff) %>% 
  rename(group = species)

surf_radar_1 <- 
  ggradar(surf_radar_data_1, centre.y = -60, legend.position = "right",
          grid.min = -60, grid.max = 5, grid.mid = 0, 
          values.radar = c("-60 %", "0 %", ""), 
          gridline.label.offset	=22, legend.text.size= 12,
          group.line.width =0.8,
          background.circle.colour	= "#ffffff", group.point.size	= 2, 
          axis.label.size=5)
surf_radar_1
ggsave("../msc-thesis-mcgill/figures/surf_radar_chap1.png", surf_radar_1, width = 15, height = 10)
```

#### Chap 2

##### Linear Graph

```{r surf_2, message=FALSE}
surf_2 <- surf %>% 
  mutate(scenario = as.factor(scenario)) %>% 
  filter(climate != "none", chapter %in% c("none", "both", "chap_2")) %>% 
  filter(climate != "none") %>% 
  group_by(scenario, species, iter) %>% 
  group_modify(~mutate(.x , baseline = subset(.x, timestep == 2010)$kp_nb, 
                       the_diff = ((kp_nb-baseline)/baseline)*100 )) %>% ungroup %>% 
  ggplot(aes(x = timestep, y = the_diff, color=climate)) +
  geom_smooth(aes(group = scenario, linetype=code_run), alpha=0.2, method="loess")+
  #geom_point(aes(group=scenario), alpha= 0.05, size = 0.5)+
  facet_wrap(~species, scales = "fixed")+
  scale_color_manual(values=c('#ffe300', '#ff7a14', "#b31400"), 
                     labels = c("Historic", "Baseline", "RCP 8.5")) +
  labs(y = "Change in nb of Keypoints detected (%)",
       x = "Year",
       col = "Climate",
       linetype = "Run") +
  guides(col = guide_legend(ncol = 2, nrow=2), 
         linetype = guide_legend(nrow=2, ncol=2, 
                                 override.aes = list(colour = 'black'))) +
  NULL
surf_2
ggsave("../msc-thesis-mcgill/figures/surf_chap2.png", surf_2, width = 15, height = 15)
```

##### Radar Graph

```{r surf_radar_2, message=FALSE}
surf_radar_data_2 <- surf %>% 
  filter(climate != "none", chapter %in% c("none", "both","chap_2")) %>% 
  filter(sce != "sce_0", name != "historic run") %>% 
  group_by(timestep, species, code) %>% 
  summarise(kp_nb = mean(kp_nb)) %>% ungroup %>% 
  pivot_wider(names_from = timestep, values_from = kp_nb) %>% 
  mutate(diff = ((`2100`-`2010`)/`2010`)*100) %>% 
  select(-c(`2010`:`2100`)) %>%  
  pivot_wider(names_from = code, values_from = diff) %>% 
  rename(group = species)

surf_radar_2 <- 
  ggradar(surf_radar_data_2, centre.y = -60, legend.position = "right",
          grid.min = -60, grid.max = 5, grid.mid = 0, 
          values.radar = c("-60 %", "0 %", ""), 
          gridline.label.offset	=22, legend.text.size= 12,
          group.line.width =0.8,
          background.circle.colour	= "#ffffff", group.point.size	= 2, 
          axis.label.size=5)
surf_radar_2
ggsave("../msc-thesis-mcgill/figures/surf_radar_chap2.png", surf_radar_2, width = 15, height = 10)
```

### Maps

```{r eval=FALSE, include=FALSE}
class = 2

# LOAD
the_stack <- stack(lapply((list.files("test/july/sce_37_for_urb_prob/", full.names = T)), raster)) == class

original <- raster("data/land_use/aggregated/aggregated_lu_buffered_1990_patched.tif") == class
final <- raster("data/land_use/aggregated/aggregated_lu_buffered_2010_patched.tif") == class
stratum <- raster("data/stsim/aggregated/primary_stratum_mont_or_not_or_PA.tif")

# Ttransform, give names
the_stack[original == 1] <- 0
final[original == 1] <- 0
the_stack[stratum==0] <- NA
final[stratum==0] <- NA
the_stack <- trim(the_stack)
final <- trim(final)

the_mean <-  mean(the_stack)
names(the_mean) <- "mean"
names(final) <- "observation"

# test <- the_mean
# test[(which(values(!is.na(final)) & values(is.na(the_mean))))] <- 100
# plot(test)

# Fill th "other" values
the_mean[(which(values(!is.na(final)) & values(is.na(the_mean))))] <- 0

# Analyze
options(yardstick.event_first = T)
crosstab(the_mean>0, final)

names(the_stack) <- rep("model", length(names(the_stack)))

aucs <- c()
precs <- c()
for (x in 1:nlayers(the_stack)){
  the_df <- as.data.frame(stack(the_stack[[x]], final)) %>% 
    drop_na() %>% 
    rename(estimate = starts_with("model"), truth = "observation")
  the_df_2 <- the_df %>% 
    mutate(truth = factor(truth, ordered = F)) %>%
    mutate(truth = relevel(.$truth, "1"))
  auc <- the_df_2 %>% 
    roc_auc(truth = truth, estimate) %>% 
    pull(.estimate)
  prec <- the_df_2 %>% 
    average_precision(truth = truth, estimate) %>% 
    pull(.estimate)
  aucs <- c(aucs, auc)
  precs <- c(precs, prec)
}
mean(aucs);sd(aucs)
mean(precs);sd(precs)
# plot(stack(the_mean, final))
```

### Original hist

```{r}
hist_plot_origin <- histograms %>%
  filter(sce %in% c("TRUE", "sce_37")) %>% 
  filter(ts == 2) %>% 
  mutate(ts = ts*10+1990) %>% 
  mutate(ts = as.factor(ts)) %>% 
  ggplot(aes(x=bins, y=n, fill=sce, colour =sce)) + 
  geom_density(stat='identity', show.legend=T, alpha=0.3)+
  scale_color_discrete(name="Source", labels=c("Model", "Observation")) +
  scale_fill_discrete(name="Source", labels=c("Model", "Observation")) +
  facet_wrap(~species) +
  labs(x = "Flow intensity distribution (log)", 
       y = "") +
  theme(strip.text.y = element_text(angle=360, size=10, hjust = 0), 
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.text.y.left = element_blank(),
        axis.ticks.y.left = element_blank()) +
  NULL
hist_plot_origin
ggsave("../msc-thesis-mcgill/figures/original_hists.png", hist_plot_origin, width = 15, height = 10)
```

### Bar charts

```{r BAU, message=FALSE, warning=FALSE}
sce_39 <- stack(lapply((list.files("test/july/sce_39_BAU/", full.names = T)), raster))
stratum <- raster("data/stsim/aggregated/primary_stratum_mont_or_not_or_PA.tif")
the_names <- names(sce_39)
sce_39[stratum == 0] <- NA
names(sce_39) <- the_names

ts_2_39 <- sce_39[[which(stringr::str_detect(names(sce_39), "ts2"))]]
ts_11_39 <- sce_39[[which(stringr::str_detect(names(sce_39), "ts11"))]]

two_stack_39 <-  stack(sce_39$sc.it5.ts2, sce_39$sc.it5.ts11)
names(two_stack_39) <- c("2010", "2100")
# plot(trim(two_stack))

ts_2_freq_39 <- freq(ts_2_39, useNA="no")
ts_11_freq_39 <- freq(ts_11_39, useNA="no")

full_df_2_39 <- data.frame()
for (x in 1:length(ts_2_freq_39)){
  temp_df_39 <- ts_2_freq_39[[x]] %>% 
    as.data.frame() %>% 
    mutate(iteration = paste0("iter_", x)) %>% 
    mutate(timestep = 2010)
  full_df_2_39 <- bind_rows(full_df_2_39, temp_df_39)
}

full_df_11_39 <- data.frame()
for (x in 1:length(ts_11_freq_39)){
  temp_df_39 <- ts_11_freq_39[[x]] %>% 
    as.data.frame() %>% 
    mutate(iteration = paste0("iter_", x)) %>% 
    mutate(timestep = 2100)
  full_df_11_39 <- bind_rows(full_df_11_39, temp_df_39)
}

full_df_39 <- bind_rows(full_df_2_39, full_df_11_39)

mean_df_39 <- full_df_39 %>% 
  group_by(timestep, value) %>% 
  summarise(mean_count = mean(count)) %>% ungroup()

sd_df_39 <- full_df_39 %>% 
  group_by(timestep, value) %>% 
  summarise(sd_count = sd(count)) %>% ungroup()

final_df_39 <- left_join(mean_df_39, sd_df_39,  by = c("timestep", "value")) %>% 
  left_join(classes_unique, 
            by=c("value"="new_code")) %>% 
  filter(!(value %in% c(4,5,6))) %>%
  mutate(area = mean_count*((90*90)/10000)) 

bar_plot_39 <- final_df_39 %>% 
  #filter(value > 10) %>% 
  mutate(value = as.factor(value), timestep = as.factor(timestep)) %>% 
  ggplot(aes(fill=timestep, y=area, x=new_class)) + 
  geom_bar(position="dodge", stat="identity") +
  #geom_errorbar(aes(ymin=mean_count-sd_count, ymax=mean_count+sd_count), width=.2,
  #               position=position_dodge(.9)) +
  theme(legend.position = c(0.85, 0.7)) +
  labs(x = "Land use Class", 
       y = "Mean Area (hectare)", 
       fill = "Year") +
  NULL
bar_plot_39
#ggsave("../msc-thesis-mcgill/figures/bar_BAU.png", bar_plot_39, width = 15, height = 10)
```

```{r reforestation, message=FALSE, warning=FALSE}
sce_42 <- stack(lapply((list.files("test/july/sce_42_Ref/", full.names = T)), raster))
stratum <- raster("data/stsim/aggregated/primary_stratum_mont_or_not_or_PA.tif")
the_names <- names(sce_42)
sce_42[stratum == 0] <- NA
names(sce_42) <- the_names

ts_2_42 <- sce_42[[which(stringr::str_detect(names(sce_42), "ts2"))]]
ts_11_42 <- sce_42[[which(stringr::str_detect(names(sce_42), "ts11"))]]

two_stack_42 <-  stack(sce_42$sc.it5.ts2, sce_42$sc.it5.ts11)
names(two_stack_42) <- c("2010", "2100")
# plot(trim(two_stack))

ts_2_freq_42 <- freq(ts_2_42, useNA="no")
ts_11_freq_42 <- freq(ts_11_42, useNA="no")

full_df_2_42 <- data.frame()
for (x in 1:length(ts_2_freq_42)){
  temp_df_42 <- ts_2_freq_42[[x]] %>% 
    as.data.frame() %>% 
    mutate(iteration = paste0("iter_", x)) %>% 
    mutate(timestep = 2010)
  full_df_2_42 <- bind_rows(full_df_2_42, temp_df_42)
}

full_df_11_42 <- data.frame()
for (x in 1:length(ts_11_freq_42)){
  temp_df_42 <- ts_11_freq_42[[x]] %>% 
    as.data.frame() %>% 
    mutate(iteration = paste0("iter_", x)) %>% 
    mutate(timestep = 2100)
  full_df_11_42 <- bind_rows(full_df_11_42, temp_df_42)
}

full_df_42 <- bind_rows(full_df_2_42, full_df_11_42)

mean_df_42 <- full_df_42 %>% 
  group_by(timestep, value) %>% 
  summarise(mean_count = mean(count)) %>% ungroup()

sd_df_42 <- full_df_42 %>% 
  group_by(timestep, value) %>% 
  summarise(sd_count = sd(count)) %>% ungroup()

final_df_42 <- left_join(mean_df_42, sd_df_42,  by = c("timestep", "value")) %>% 
  left_join(classes_unique, 
            by=c("value"="new_code")) %>% 
  filter(!(value %in% c(4,5,6))) %>%
  mutate(area = mean_count*((90*90)/10000))

bar_plot_42 <- final_df_42  %>% 
  #filter(value > 10) %>% 
  mutate(value = as.factor(value), timestep = as.factor(timestep)) %>% 
  ggplot(aes(fill=timestep, y=area, x=new_class)) + 
  geom_bar(position="dodge", stat="identity") +
  #geom_errorbar(aes(ymin=mean_count-sd_count, ymax=mean_count+sd_count), width=.2,
  #               position=position_dodge(.9)) +
  theme(legend.position = c(0.85, 0.7)) +
  labs(x = "Land use Class", 
       y = "Mean Area (hectare)", 
       fill = "Year") +
  NULL
bar_plot_42
#ggsave("../msc-thesis-mcgill/figures/bar_Ref.png", bar_plot_42, width = 15, height = 10)
```

```{r}
final_df_39 <- final_df_39 %>% 
  mutate(sce = "BAU") %>% 
  mutate(type = ifelse(value <10, "non_forest", "forest"))
final_df_42 <- final_df_42 %>% 
  mutate(sce = "Reforestation")  %>% 
  mutate(type = ifelse(value <10, "non_forest", "forest"))

final_all <- bind_rows(final_df_39, final_df_42)

forest <- final_all %>% 
  filter(type == "forest") %>% 
  mutate(value = as.factor(value), timestep = as.factor(timestep)) %>% 
  ggplot(aes(fill=timestep, y=area, x=new_class)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(legend.position = "none") +
  facet_grid(~sce) +
  labs(x = "Land use Class", 
       y = "Mean Area (hectare)", 
       fill = "Year") +
  NULL

non_forest <- final_all %>% 
  filter(type != "forest") %>% 
  mutate(value = as.factor(value), timestep = as.factor(timestep)) %>% 
  ggplot(aes(fill=timestep, y=area, x=new_class)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(legend.position = "right") +
  facet_grid(~sce) +
  labs(x = "Land use Class", 
       y = "Mean Area (hectare)", 
       fill = "Year") +
  NULL

assembled <- wrap_plots(forest, non_forest, ncol=1, nrow=2)
assembled
ggsave("../msc-thesis-mcgill/figures/bar_both.png", assembled, width = 15, height = 20)
```

